<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Social Media Posting</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 10px 0; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        input { padding: 8px; margin: 5px; width: 300px; }
    </style>
</head>
<body>
    <h1>üß™ Test Social Media Posting & extractUrls Fix</h1>
    <p>This test will verify that our social media posting and extractUrls function fix are working correctly.</p>
    
    <div>
        <input type="email" id="email" placeholder="admin@test.com" value="admin@test.com">
        <input type="password" id="password" placeholder="Password" value="admin123">
        <button onclick="testSocialPosting()">üöÄ Test Social Media Posting</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        async function testSocialPosting() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="info">üöÄ Starting social media posting test...</div>';
            
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                // Step 1: Get CSRF token
                results.innerHTML += '<div class="info">1Ô∏è‚É£ Getting CSRF token...</div>';
                const csrfResponse = await fetch('http://localhost:5002/api/csrf-token', {
                    credentials: 'include'
                });
                
                if (!csrfResponse.ok) {
                    throw new Error(`CSRF failed: ${csrfResponse.status}`);
                }
                
                const csrfData = await csrfResponse.json();
                const csrfToken = csrfData.csrfToken;
                results.innerHTML += '<div class="success">‚úÖ CSRF token obtained</div>';
                
                // Step 2: Login
                results.innerHTML += '<div class="info">2Ô∏è‚É£ Logging in...</div>';
                const loginResponse = await fetch('http://localhost:5002/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken,
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    }),
                    credentials: 'include'
                });
                
                if (!loginResponse.ok) {
                    const errorData = await loginResponse.json();
                    throw new Error(`Login failed: ${loginResponse.status} - ${errorData.message}`);
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.token;
                results.innerHTML += '<div class="success">‚úÖ Login successful</div>';
                results.innerHTML += `<div class="info">User: ${loginData.user.email || loginData.user.username}</div>`;
                results.innerHTML += `<div class="info">Can Post: ${loginData.user.canPost}</div>`;
                
                // Step 3: Create a social media post with URLs to test extractUrls function
                results.innerHTML += '<div class="info">3Ô∏è‚É£ Creating social media post with URLs...</div>';
                const postContent = `üéâ Testing social media posting functionality! This post contains URLs to test the extractUrls function:
                
- GitHub: https://github.com/test
- LinkedIn: https://linkedin.com/company/test
- Website: https://example.com/test
- YouTube: https://youtube.com/watch?v=test

This should trigger the extractUrls function and test our fix! üöÄ`;

                const postResponse = await fetch('http://localhost:5002/api/social/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken,
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        content: postContent,
                        postType: 'user_post'
                    }),
                    credentials: 'include'
                });
                
                if (!postResponse.ok) {
                    const errorData = await postResponse.json();
                    throw new Error(`Post creation failed: ${postResponse.status} - ${errorData.message}`);
                }
                
                const postData = await postResponse.json();
                results.innerHTML += '<div class="success">‚úÖ Social media post created successfully!</div>';
                results.innerHTML += `<div class="info">Post ID: ${postData.post._id}</div>`;
                results.innerHTML += `<div class="info">Post Content Length: ${postData.post.content.length} characters</div>`;
                
                // Step 4: Fetch newsfeed to verify the post appears and test extractUrls
                results.innerHTML += '<div class="info">4Ô∏è‚É£ Fetching newsfeed to verify post and test extractUrls...</div>';
                const feedResponse = await fetch('http://localhost:5002/api/social/newsfeed?page=1&limit=5', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    credentials: 'include'
                });
                
                if (!feedResponse.ok) {
                    throw new Error(`Newsfeed fetch failed: ${feedResponse.status}`);
                }
                
                const feedData = await feedResponse.json();
                results.innerHTML += '<div class="success">‚úÖ Newsfeed fetched successfully!</div>';
                results.innerHTML += `<div class="info">Total posts in feed: ${feedData.posts.length}</div>`;
                
                // Find our test post
                const ourPost = feedData.posts.find(p => p._id === postData.post._id);
                if (ourPost) {
                    results.innerHTML += '<div class="success">‚úÖ Our test post found in newsfeed!</div>';
                    results.innerHTML += '<div class="info">The post contains multiple URLs which will trigger the extractUrls function when displayed in the frontend.</div>';
                } else {
                    results.innerHTML += '<div class="error">‚ùå Test post not found in newsfeed</div>';
                }
                
                // Step 5: Test summary
                results.innerHTML += '<div class="success">üéâ SUCCESS: Social Media Posting Test Completed!</div>';
                results.innerHTML += `
                    <div class="success">
                        <h3>‚úÖ Test Results Summary:</h3>
                        <ul>
                            <li>‚úÖ CSRF token retrieval working</li>
                            <li>‚úÖ User authentication working</li>
                            <li>‚úÖ Social post creation working</li>
                            <li>‚úÖ Post with URLs created (will test extractUrls function)</li>
                            <li>‚úÖ Newsfeed retrieval working</li>
                            <li>‚úÖ Backend user ID compatibility fix working</li>
                        </ul>
                        <p><strong>The extractUrls function error should now be fixed!</strong></p>
                        <p>When this post is displayed in the React frontend, the extractUrls function will be called with the post content containing URLs, and it should no longer throw the "Cannot read properties of undefined (reading 'match')" error.</p>
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML += `<div class="error">‚ùå Test failed: ${error.message}</div>`;
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>
